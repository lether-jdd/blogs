---
title: web性能
date: 2020-03-17 21:13:51
tags:
- web性能
categories: 
- 性能
- web
---
我们通常通过性能指标来衡量Web应用是否具有良好的加载体验，无论是 Chrome Devtools 还是 W3C 提供的 Navigation Timing API 都提供了许多参考指标，这些指标中哪些是需要重点关注，能够真实反映页面加载和渲染效率的呢？这里先回顾一下浏览器渲染机制，了解一下需要注意的关键节点。
# 1 浏览器渲染过程
- 获取HTML文档。浏览器从磁盘或网络读取 HTML 的原始字节。
- 解析HTML文档。解析 HTML 内容，加载<head>和<body>中的静态文件。
- 构建 DOM 和 CSSOM，合并成渲染树。将 HTML 转换成令牌，形成树模型。
- 布局和绘制。渲染树生成“盒模型”，获得视口内的确切位置和大小，将渲染树节点绘制为屏幕上的实际像素。
- 完全加载。开始加载异步资源，同时也会下载字体、图片等远程文件。
经过以上5个阶段，就完成了网页的加载和渲染。有效的利用Web性能指标的关键就在于抓住1~5阶段的关键时间点，以此找到相对应的性能优化策略。
# 2页面加载关键时间点
☆ 首字节时间
    指浏览器接收到 HTML 文档第一个字节的时间。此时间点之前，浏览器需要经过 DNS解析、重定向(若有)、建立 TCP/SSL 连接、服务器响应等过程。
☆ DOM 构建完成时间
    HTML 解析器完成 DOM 树构建的时间。此时间点之前，浏览器需要经过同步静态资源加载、内联 JavaScript 脚本运行、HTML 解析器生成 DOM 树的过程。
☆ DOM Ready 时间
    CSS树和DOM树合并渲染树后，并执行完成同步 JavaScript 脚本的时间。此时间点之前，包含了DOM树构建的过程、CSS树构建的过程、以及同步 JavaScript 脚本执行的时间。
☆ 首屏时间
    网页布局和绘制的完成，将用户设备视窗范围内的DOM节点渲染完成的时间。若首屏中包含异步请求才能完成渲染的内容，则需要包含等待异步请求和页面重绘的时间。
☆ 页面完全加载时间
    所有处理完成，并且网页上的所有资源（图像等）都已下载完毕的时间。此时会触发浏览器 onload 事件。

以上这些时间点，该如何进行检查和使用呢？在 2012年以后 W3C 提供了 Navigation Timing API 指标接口，我们尝试找出与上述各时间点之间的对应关系。

# 3 w3c提供的性能指标
W3C提供了大量的性能指标，对能够衡量性能的关键时间，这里做了整理：

首字节时间：responseStart

Dom 构建完成时间：domInteractive

Dom Ready时间：DOMContentLoadedEventEnd

页面完全加载时间：loadEventStart

首屏时间：无法体现

Navigation Timing API 提供了文档构建过程中的多数性能指标，对于传统的直出型页面，由于没有模块的异步加载页面过程，所以我们认为它的首次渲染时间即为DOM构建完成时间，页面渲染完毕即为页面完全加载时间。

但是对于 SPA（Single Page Application） 类型的页面，由于存在异步模块及远程数据的加载过程，需要找到一个能够衡量首次渲染和首屏时间的指标，于是下面会对 SPA 模式下的网页渲染指标进行更深入的探索。

# 4 spa首屏渲染
  SPA 页面与传统直出页面最大不同在于 JS 对象与 DOM 结构之间的相互响应。由于这种模式在 HTML 解释器在遍历主文档时只挂载一个​<div id="app"> 节点，当 HTML 结构解析完毕时，真实的页面主体还未从 JS 对象转换成 DOM 插入页面。因此针对这种情况，需要单独分析与验证，
  观察到SPA项目在 DCL（SPA框架逻辑执行结束） 后，浏览器进行了首次渲染
  raptor提出了一个spa的采集计算模型。
  计算模型中将首屏时间定义为浏览器视窗范围内的 DOM 达到稳定状态的时间。为了监测这个稳定状态，核心算法主要使用接口：MutationObserver。MutationObserver 实例能够监听 DOM 变化并执行回调。当一定时间内没有再监听到首屏内 DOM 变化时，即可得出结果并停止监听。

# 5 web性能问题排查
￼![](/images/drawio.svg)